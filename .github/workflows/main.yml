name: Build & Release Medi-Time TWA

on:

  workflow_dispatch:

jobs:

  build-and-release:

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v3

      - name: Set up Node.js

        uses: actions/setup-node@v4

        with:

          node-version: '18'

      - name: Install Bubblewrap CLI

        run: npm install -g @bubblewrap/cli

      - name: Set up JDK 17

        uses: actions/setup-java@v4

        with:

          distribution: 'temurin'

          java-version: '17'

      - name: Restore keystore

        run: |

          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.keystore

      - name: Build TWA with signing

        run: |

          bubblewrap build \

            --keystore release.keystore \

            --keystorePassword ${{ secrets.KEYSTORE_PASSWORD }} \

            --keyAlias ${{ secrets.KEY_ALIAS }} \

            --keyPassword ${{ secrets.KEY_PASSWORD }}

      - name: Create GitHub Release

        uses: ncipollo/release-action@v1

        with:

          artifacts: "app-release-signed.apk"

          tag: "release-${{ github.run_number }}"

          token: ${{ secrets.GITHUB_TOKEN }}